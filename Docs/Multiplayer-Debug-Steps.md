# 多人模式调试步骤

## 问题
在星际争霸1多人模式下，"加钱"和"建造加速"功能不起作用。

## 已添加的调试功能

### 1. 详细日志
现在所有内存操作都会输出详细的诊断信息：
- 实际使用的内存地址
- 读取到的值
- 写入后的验证值
- 异常警告（如果读取到不合理的值）

### 2. 玩家索引扫描器
新增了一个"🔍 扫描玩家索引"按钮，可以扫描所有8个玩家槽位的资源值。

## 调试步骤

### 步骤1：启动游戏并使用扫描功能
1. 以**管理员权限**启动 GameCheatHelper
2. 启动星际争霸1，进入多人模式游戏
3. 等待GameCheatHelper检测到游戏
4. 在游戏中查看你当前的资源数量（例如：矿物50，瓦斯0）
5. 点击 **"🔍 扫描玩家索引"** 按钮
6. 会弹出提示框告诉你扫描完成

### 步骤2：查看日志文件
1. 打开GameCheatHelper所在目录的 **logs** 文件夹
2. 打开最新的日志文件（按时间排序）
3. 搜索 "🔍 开始扫描玩家索引"
4. 你会看到类似这样的输出：
   ```
   玩家 0: 矿物=0, 瓦斯=0 (地址: 0x57F0F0)
   玩家 1: 矿物=50, 瓦斯=0 (地址: 0x57F114)
   ✅ 可能的玩家索引: 1 (矿物=50, 瓦斯=0)
   玩家 2: 矿物=12345678, 瓦斯=-1 (地址: 0x57F138)
   ...
   ```

### 步骤3：确定你的玩家索引
- 找到与你游戏中资源数量**完全匹配**的那一行
- 记下对应的玩家索引号（例如：1）
- 如果有多个匹配，都记下来准备测试

### 步骤4：测试确认
1. 点击"💰 加钱"按钮
2. 查看日志中的：
   - `🔍 矿物地址: 0x...` - 实际使用的地址
   - `当前资源 - 水晶矿: XX, 瓦斯: YY` - 读取到的值
   - `🔍 写入后验证` - 写入是否成功

### 步骤5：分析结果

#### 情况A：找到了正确的玩家索引
如果扫描结果中玩家索引N的资源与游戏一致，说明：
- **单人模式**：玩家索引可能是0（当前代码假设）
- **多人模式**：玩家索引可能是1-7中的某个值

**解决方案**：需要动态检测玩家索引，而不是硬编码为0。

#### 情况B：所有玩家的资源值都不匹配
可能的原因：
- 内存地址在你的星际争霸版本中不同
- 多人模式使用了完全不同的内存结构
- 需要使用Cheat Engine等工具重新定位地址

#### 情况C：写入失败（日志显示验证失败）
可能的原因：
- 内存保护机制阻止写入
- 需要更高权限（已经是管理员了）
- 多人模式有反作弊保护

## 临时解决方案

如果确定了正确的玩家索引（例如索引1），可以临时修改代码测试：

### 修改位置1：MainViewModel.cs
找到 `AddResourcesCommand` 相关的执行代码，将 `playerIndex: 0` 改为你的索引：

```csharp
// 例如改为索引1
_memoryCheatService.AddStarCraftResources(_currentGame.ProcessId, 1, 10000, 10000);
```

### 修改位置2：MemoryCheatService.cs
或者直接修改 `AddStarCraftResources` 方法的默认参数：

```csharp
public bool AddStarCraftResources(int processId, int playerIndex = 1, ...) // 改为1或其他值
```

## 长期解决方案

需要实现动态玩家索引检测：

### 方案1：自动检测
在每次操作前，自动扫描找到资源值在合理范围内且非零的槽位。

### 方案2：用户配置
添加一个设置选项，让用户手动设置玩家索引（在扫描后）。

### 方案3：智能匹配
- 在游戏开始时记录初始资源（通常是50矿物）
- 持续监控资源变化
- 识别哪个槽位的资源在变化，即为当前玩家

## 相关文件

- 日志输出：`logs/` 目录
- 扫描功能代码：[MemoryCheatService.cs](../Services/MemoryCheatService.cs#L153) - `ScanForPlayerIndex()` 方法
- UI按钮：[MainWindow.xaml](../Views/MainWindow.xaml#L237) - 扫描按钮
- 命令处理：[MainViewModel.cs](../ViewModels/MainViewModel.cs#L464) - `ScanPlayerIndex()` 方法

## 下一步

1. **立即行动**：运行扫描功能，查看日志结果
2. **反馈信息**：告诉我扫描到的玩家索引情况
3. **针对性修复**：根据扫描结果决定修复方案

---

**注意事项：**
- 必须以管理员权限运行
- 确保游戏已经开始（不是在菜单界面）
- 多人模式需要进入实际游戏，不是大厅
- 日志文件位于软件目录的 logs 文件夹
